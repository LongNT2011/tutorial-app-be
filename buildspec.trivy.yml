version: 0.2
env:
  variables:
    BeImageName: "longnt20/csvprocessor"
phases:
  build:
    commands:
      - echo "Building the Docker image for Trivy scan..."
      - echo "Scanning image for vulnerabilities with Trivy..."
      - trivy image --severity HIGH,CRITICAL -f json -o results.json $BeImageName:latest
      - echo "Checking Trivy scan results..."
      - cat results.json
      - |
        CRITICAL=$(jq '[.Results[] | select(.Vulnerabilities != null) | .Vulnerabilities[] | select(.Severity == "CRITICAL")] | length' results.json || echo 0)
        HIGH=$(jq '[.Results[] | select(.Vulnerabilities != null) | .Vulnerabilities[] | select(.Severity == "HIGH")] | length' results.json || echo 0)
        if [ "$CRITICAL" -gt 0 ]; then
          echo "FAIL: Found $CRITICAL Critical vulnerabilities. Please address them before proceeding."
        elif [ "$HIGH" -gt 0 ]; then
          echo "WARNING: Found $HIGH High vulnerabilities. Please consider addressing them."
        else
          echo "PASS: No High or Critical vulnerabilities found."
        fi
  post_build:
    commands:
      - echo "Deleting image after scan..."
      - docker rmi $BeImageName:latest || true
